<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;overflow:hidden;}

video{
position:fixed;
width:100%;
height:100%;
object-fit:cover;
}

.overlay{
position:fixed;
top:50%;
left:50%;
transform:translate(-50%,-50%) scale(1) rotate(0deg);
touch-action:none;
border-radius:8px;
background:white;
}

button{
position:fixed;
bottom:20px;
left:50%;
transform:translateX(-50%);
padding:12px 25px;
background:#00c3ff;
border:none;
color:white;
border-radius:8px;
}
</style>
</head>

<body>

<video id="cam" autoplay playsinline muted></video>

{% if file.endswith('.pdf') %}
<embed id="overlay" class="overlay"
src="/uploads/{{file}}" width="300" height="400">
{% else %}
<img id="overlay" class="overlay"
src="/uploads/{{file}}" width="250">
{% endif %}

<button onclick="capture()">Capture</button>

<script>
const video=document.getElementById("cam");
const overlay=document.getElementById("overlay");

let scale=1, rotate=0, posX=0, posY=0;
let startX,startY,dist0,angle0;

// BACK CAMERA
navigator.mediaDevices.getUserMedia({
 video:{facingMode:"environment"}
}).then(s=>video.srcObject=s);

// TOUCH GESTURES
overlay.addEventListener("touchstart",e=>{
 if(e.touches.length==1){
  startX=e.touches[0].clientX-posX;
  startY=e.touches[0].clientY-posY;
 }

 if(e.touches.length==2){
  let dx=e.touches[0].clientX-e.touches[1].clientX;
  let dy=e.touches[0].clientY-e.touches[1].clientY;
  dist0=Math.sqrt(dx*dx+dy*dy);
  angle0=Math.atan2(dy,dx);
 }
});

overlay.addEventListener("touchmove",e=>{
 e.preventDefault();

 if(e.touches.length==1){
  posX=e.touches[0].clientX-startX;
  posY=e.touches[0].clientY-startY;
 }

 if(e.touches.length==2){
  let dx=e.touches[0].clientX-e.touches[1].clientX;
  let dy=e.touches[0].clientY-e.touches[1].clientY;

  let dist=Math.sqrt(dx*dx+dy*dy);
  scale*=dist/dist0;
  dist0=dist;

  let angle=Math.atan2(dy,dx);
  rotate+=(angle-angle0)*180/Math.PI;
  angle0=angle;
 }

 overlay.style.transform=
  `translate(${posX}px,${posY}px)
   scale(${scale})
   rotate(${rotate}deg)`;
});

// CAPTURE PHOTO
function capture(){
 let canvas=document.createElement("canvas");
 let ctx=canvas.getContext("2d");

 canvas.width=window.innerWidth;
 canvas.height=window.innerHeight;

 ctx.drawImage(video,0,0,canvas.width,canvas.height);

 let rect=overlay.getBoundingClientRect();
 ctx.drawImage(overlay,rect.left,rect.top,
 rect.width,rect.height);

 let a=document.createElement("a");
 a.href=canvas.toDataURL();
 a.download="AR_capture.png";
 a.click();
}
</script>

</body>
</html>
